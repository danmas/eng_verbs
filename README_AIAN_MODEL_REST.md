# REST API сервера AIAN-MODEL

Документация по REST API для управления промптами и историей ответов.


## API для отправки запросов к AI моделям

### Отправка запроса к AI модели через сервер

```
POST /api/send-request
```

**Тело запроса:**
```json
{
  "model": "google/gemini-2.0-flash-exp:free",
  "prompt": "Текст системного промпта",
  "inputText": "Текст пользовательского запроса",
  "saveResponse": false,
  "useRag": false,
  "contextCode": "code1"
}
```

**Ответ (успешный):**
```json
{
  "success": true,
  "content": "Ответ от AI модели",
  "model": "google/gemini-2.0-flash-exp:free",
  "usage": {
    "prompt_tokens": 42,
    "completion_tokens": 128,
    "total_tokens": 170
  }
}
```

**Ответ (ошибка):**
```json
{
  "error": "Описание ошибки"
}
```

**Ответ (ошибка) с расширенной информацией:**
```json
{
  "error": "Описание ошибки",
  "data": {
    // Содержит полные данные ответа от API при некорректной структуре ответа
  }
}
```

или

```json
{
  "error": "Описание ошибки",
  "details": {
    // Содержит дополнительную информацию об ошибке, например:
    // - данные ответа от API при ошибке API
    // - информация о запросе при сетевых ошибках
    // - стек ошибки при общих ошибках выполнения
  }
}
```

**Параметры запроса:**
- `model` (обязательный) - идентификатор модели AI для использования
- `prompt` (обязательный) - системный промпт для модели
- `inputText` (обязательный) - запрос пользователя
- `saveResponse` (необязательный, по умолчанию `false`) - флаг для автоматического сохранения ответа в историю
- `useRag` (необязательный, по умолчанию `false`) - флаг для использования RAG
- `contextCode` (необязательный) - код контекста для RAG, если useRag=true

### Проверка доступности API-ключа

```
GET /api/check-api-key
```

**Ответ:**
```json
{
  "isAvailable": true,
  "serviceProvider": "OpenRouter"
}
```

## Преимущества отправки запросов через сервер

1. **Безопасность** - API-ключи не передаются на клиентскую сторону
2. **Мониторинг** - все запросы логируются на сервере
3. **Централизованный контроль** - легко внедрить ограничения, квоты или проверки
4. **Кэширование** - возможность реализовать кэширование ответов на стороне сервера
5. **Надежность** - лучшая обработка ошибок и повторных попыток

## Использование в интерфейсе

В пользовательском интерфейсе добавлены две кнопки для отправки запросов:

- **Send Request (Client)** - отправляет запрос напрямую к API из браузера
- **Send Request (Server)** - отправляет запрос через серверный эндпоинт

Рекомендуется использовать серверный метод для большинства случаев, особенно в продакшн-окружении.


## Конфигурация

### Получение текущей конфигурации сервера

```
GET /api/config
```

**Ответ:**
```json
{
  "server": {
    "port": "3000",
    "nodeEnv": "development",
    "isTestMode": false
  },
  "n8n": {
    "webhookUrl": "https://example.com/webhook"
  },
  "apiKey": "your-openrouter-api-key",
  "logging": {
    "level": "info",
    "filename": "combined.log",
    "errorFilename": "error.log"
  }
}
```

## Управление промптами

### Получение списка всех промптов

```
GET /api/prompts
```

**Ответ:**
```json
[
  {
    "name": "Анализ текста",
    "text": "Проанализируй следующий текст: {{text}}"
  },
  {
    "name": "Генерация идей",
    "text": "Предложи 5 идей для: {{topic}}"
  }
]
```

### Добавление нового промпта

```
POST /api/prompts
```

**Тело запроса:**
```json
{
  "name": "Новый промпт",
  "text": "Содержание промпта"
}
```

**Ответ:**
```json
{
  "message": "Prompt added successfully"
}
```

### Обновление существующего промпта

```
PUT /api/prompts/:name
```

**Параметры пути:**
- `name` - имя промпта для обновления

**Тело запроса:**
```json
{
  "text": "Новое содержание промпта"
}
```

**Ответ:**
```json
{
  "message": "Prompt updated successfully"
}
```

### Удаление промпта

```
DELETE /api/prompts/:name
```

**Параметры пути:**
- `name` - имя промпта для удаления

**Ответ:**
```json
{
  "message": "Prompt deleted successfully"
}
```

## Управление историей ответов

### Получение истории ответов

```
GET /api/responses
```

**Параметры запроса:**
- `sortBy` - поле для сортировки (необязательно)
- `sortOrder` - порядок сортировки: `asc` или `desc` (необязательно)
- `model` - фильтр по модели (необязательно)
- `prompt` - фильтр по имени промпта (необязательно)
- `dateFrom` - фильтр по начальной дате (необязательно)
- `dateTo` - фильтр по конечной дате (необязательно)
- `limit` - ограничение количества результатов (необязательно)

**Ответ:**
```json
[
  {
    "id": "1615293487123",
    "timestamp": "2023-03-09T12:31:27.123Z",
    "model": "gpt-3.5-turbo",
    "promptName": "Анализ текста",
    "prompt": "Проанализируй следующий текст: {{text}}",
    "inputText": "Пример текста для анализа",
    "response": "Ответ модели на запрос"
  }
]
```

### Сохранение нового ответа

```
POST /api/responses
```

**Тело запроса:**
```json
{
  "model": "gpt-3.5-turbo",
  "promptName": "Анализ текста",
  "prompt": "Проанализируй следующий текст: {{text}}",
  "inputText": "Пример текста для анализа",
  "response": "Ответ модели на запрос"
}
```

**Ответ:**
```json
{
  "message": "Response saved successfully",
  "id": "1615293487123"
}
```

### Удаление записи из истории

```
DELETE /api/responses/:id
```

**Параметры пути:**
- `id` - идентификатор записи для удаления

**Ответ:**
```json
{
  "message": "Response deleted successfully"
}
```

## Структура файлов хранения данных

Данные хранятся в JSON-файлах:

- **Промпты:** `../../MYDATA/ai-analytics/prompts.json`
- **История ответов:** `../../MYDATA/ai-analytics/responses.json`

## Конфигурация сервера

Конфигурация сервера загружается из файла `props.env` и доступна через объект `config`:

- `port` - порт сервера (по умолчанию 3000)
- `n8nWebhookUrl` - URL для вебхука n8n
- `isTestMode` - флаг тестового режима
- `openRouterKey` - ключ API для OpenRouter
- `logging` - настройки логирования



---
---

### Отправка запроса к AI модели с выбором промпта по имени

```
POST /api/send-request-sys
```

**Тело запроса:**
```json
{
  "model": "google/gemini-2.0-flash-exp:free",
  "prompt_name": "Имя системного промпта",
  "inputText": "Текст пользовательского запроса",
  "saveResponse": true
}
```

**Параметры запроса:**
- `model` (обязательный) - идентификатор модели AI для использования
- `prompt_name` (обязательный) - имя системного промпта, хранящегося в базе промптов
- `inputText` (обязательный) - запрос пользователя
- `saveResponse` (необязательный, по умолчанию `true`) - флаг для автоматического сохранения ответа в историю

**Ответ (успешный):**
```json
{
  "success": true,
  "content": "Ответ от AI модели",
  "model": "google/gemini-2.0-flash-exp:free",
  "usage": {
    "prompt_tokens": 42,
    "completion_tokens": 128,
    "total_tokens": 170
  },
  "prompt_used": {
    "name": "Имя системного промпта",
    "text": "Текст системного промпта"
  }
}
```

**Ответ (ошибка):**
```json
{
  "error": "Описание ошибки"
}
```

**Ответ (ошибка) с расширенной информацией:**
```json
{
  "error": "Описание ошибки",
  "data": {
    // Содержит полные данные ответа от API при некорректной структуре ответа
  }
}
```

или

```json
{
  "error": "Описание ошибки",
  "details": {
    // Содержит дополнительную информацию об ошибке, например:
    // - данные ответа от API при ошибке API
    // - информация о запросе при сетевых ошибках
    // - стек ошибки при общих ошибках выполнения
  }
}
```

**Особенности:**
- Промпт выбирается по имени из хранилища промптов
- Ответ автоматически сохраняется в историю (если параметр `saveResponse` не установлен в `false`)
- В ответе возвращается информация об использованном промпте

### Получение списка доступных промптов

```
GET /api/available-prompts
```

**Ответ:**
```json
[
  {
    "name": "Анализ текста",
    "text": "Проанализируй следующий текст: {{text}}"
  },
  {
    "name": "Генерация идей",
    "text": "Предложи 5 идей для: {{topic}}"
  }
]
```

## Тройной интерфейс отправки запросов

В пользовательском интерфейсе теперь доступны три кнопки для отправки запросов:

1. **Send (Client)** - отправляет запрос напрямую к API из браузера
2. **Send (Server)** - отправляет запрос через серверный эндпоинт с указанным в форме промптом
3. **Send (Using Prompt)** - отправляет запрос, используя промпт, выбранный по имени из хранилища

**Рекомендации по использованию:**

- **Send (Using Prompt)** - рекомендуется для большинства случаев, так как обеспечивает стандартизацию запросов и автоматическое сохранение
- **Send (Server)** - полезен для экспериментов с промптами без их сохранения в хранилище
- **Send (Client)** - для отладки и тестирования API на стороне клиента

**Технические преимущества маршрута `/api/send-request-sys`:**

1. **Стандартизация промптов** - все пользователи используют одни и те же проверенные промпты
2. **Автоматическое сохранение** - каждый запрос и ответ по умолчанию сохраняются в историю (с возможностью отключения через параметр saveResponse)
3. **Упрощенный интерфейс** - пользователю достаточно выбрать имя промпта, а не вводить весь текст
4. **Версионирование промптов** - промпты можно изменять центрально без изменения клиентского кода

## API для работы с Retrieval-Augmented Generation (RAG)

### Получение списка контекстных кодов

```
GET /api/rag/context-codes
```

**Ответ:**
```json
[
  "code1",
  "code2",
  "code3"
]
```

### Получение списка документов

```
GET /api/rag/documents
```

**Ответ:**
```json
[
  {
    "id": "1",
    "filename": "document1.txt",
    "contextCode": "code1",
    "source": "source1"
  }
]
```

### Запрос к RAG с использованием контекстного кода

```
POST /api/rag/ask
```

**Тело запроса:**
```json
{
  "question": "Вопрос пользователя",
  "contextCode": "code1",
  "showDetails": true
}
```

**Параметры запроса:**
- `question` (обязательный) - вопрос для запроса к базе знаний
- `contextCode` (необязательный) - фильтр по коду контекста для поиска документов
- `showDetails` (необязательный, по умолчанию `false`) - показывать детальную информацию о найденных документах

**Ответ:**
```json
{
  "answer": "Ответ, основанный на документах",
  "documents": [
    {
      "pageContent": "Содержимое документа",
      "metadata": {
        "filename": "document1.txt",
        "source": "source1",
        "contextCode": "code1"
      }
    }
  ],
  "contextCode": "code1"
}
```

### Получение отладочной информации RAG

```
GET /api/rag/debug-info
```

**Ответ:**
```json
{
  "ragEnabled": true,
  "finalInputText": "Контекст из базы знаний: ... Вопрос пользователя: ...",
  "ragInfo": {
    "used": true,
    "contextCode": "code1",
    "documentsCount": 3,
    "sources": [
      {
        "filename": "document1.txt",
        "source": "source1",
        "contextCode": "code1"
      }
    ]
  },
  "timestamp": "2023-03-09T12:31:27.123Z"
}
```

## API для работы с файлами

### Сохранение файла markdown

```
POST /api/save-markdown
```

**Тело запроса:**
```json
{
  "content": "# Markdown содержимое\n\nТекст документа",
  "filename": "document.md",
  "directory": "path/to/directory"
}
```

**Параметры запроса:**
- `content` (обязательный) - содержимое markdown файла для сохранения
- `filename` (необязательный) - имя файла (если не указано, генерируется автоматически)
- `directory` (необязательный) - директория для сохранения (если не указана, используется OUTPUT_DOCS_DIR)

**Ответ:**
```json
{
  "success": true,
  "filePath": "path/to/directory/document.md",
  "message": "Файл успешно сохранен: path/to/directory/document.md"
}
```

### Получение информации о директории документов

```
GET /api/output-dir-info
```

**Ответ:**
```json
{
  "outputDir": "output_docs",
  "exists": true,
  "files": [
    {
      "name": "document1.md",
      "path": "output_docs/document1.md",
      "size": 1024
    }
  ]
}
```

## Дополнительные API маршруты

### Альтернативный маршрут для отправки запросов к AI моделям

```
POST /analyze
```

**Тело запроса:**
```json
{
  "model": "google/gemini-2.0-flash-exp:free",
  "prompt": "Текст системного промпта",
  "inputText": "Текст пользовательского запроса",
  "useRag": true,
  "contextCode": "code1"
}
```

**Параметры запроса:**
- `model` (обязательный) - идентификатор модели AI для использования
- `prompt` (обязательный) - системный промпт для модели
- `inputText` (обязательный) - запрос пользователя
- `useRag` (необязательный, по умолчанию `false`) - флаг для использования RAG
- `contextCode` (необязательный) - код контекста для RAG, если useRag=true

**Ответ (успешный):**
```json
{
  "success": true,
  "content": "Ответ от AI модели",
  "model": "google/gemini-2.0-flash-exp:free",
  "usage": {
    "prompt_tokens": 42,
    "completion_tokens": 128,
    "total_tokens": 170
  },
  "rag": {
    "used": true,
    "contextCode": "code1",
    "documentsCount": 3,
    "sources": [
      {
        "filename": "document1.txt",
        "source": "source1",
        "contextCode": "code1"
      }
    ]
  }
}
```

**Ответ (ошибка) с расширенной информацией:**
```json
{
  "error": "Описание ошибки",
  "data": {
    // Содержит полные данные ответа от API при некорректной структуре ответа
  }
}
```

или

```json
{
  "error": "Описание ошибки",
  "details": {
    // Содержит дополнительную информацию об ошибке, например:
    // - данные ответа от API при ошибке API
    // - информация о запросе при сетевых ошибках
    // - стек ошибки при общих ошибках выполнения
  }
}
```

### Получение списка доступных моделей

```
GET /api/available-models
```

**Ответ:**
```json
[
  "google/gemma-3-27b-it:free",
  "google/gemini-2.0-flash-exp:free",
  "google/gemini-2.0-flash-lite-preview-02-05:free",
  "deepseek/deepseek-chat:free",
  "qwen/qwen2.5-vl-72b-instruct:free"
]
```

### Получение информации о сервере

```
GET /server-info
```

**Ответ:**
```json
{
  "hostname": "server-name",
  "platform": "win32",
  "arch": "x64",
  "nodeVersion": "v18.16.0",
  "uptime": 3600,
  "baseUrl": "http://localhost:3002",
  "port": "3002",
  "appName": "AI Analytics Interface",
  "timestamp": "2023-03-09T12:31:27.123Z"
}
```